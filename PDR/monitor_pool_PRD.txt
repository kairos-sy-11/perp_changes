# 监控池管理模块（合约自动识别与维护）

### 4.1 背景与目标

- 当前版本通过手动输入 symbol（如 BTCUSDT、ETHUSDT）配置监控对象。
- 目标：自动识别 Binance 上所有满足条件的 USDT‑M 永续合约，并维护为「监控池」，减少人工维护成本，同时控制更新频率，避免对交易所接口的重复、高频请求。

### 4.2 监控范围定义

- 交易所：Binance Futures（USDT‑M）。
- 合约筛选条件：
    - `contractType = PERPETUAL`（永续合约）
    - `status = TRADING`（正在交易）
    - `quoteAsset = USDT`（USDT 报价）
- 监控池（Watchlist）：
    - 由系统自动维护的合约 symbol 集合，如：`["BTCUSDT", "ETHUSDT", "SOLUSDT", …]`。
    - 作为后续 CVD / OI / Funding 等监控逻辑的输入，不再依赖手工硬编码。

### 4.3 首次监控池生成

- 触发时机：
    - 第一次启动程序时。
    - 或本地不存在任何监控池数据时（例如配置文件缺失或损坏）。
- 行为：
    1. 从 Binance 拉取所有期货合约元数据。
    2. 按 4.2 的条件筛选出所有 USDT‑M 永续、状态为 TRADING 的合约 symbol。
    3. 将筛选结果作为「初始监控池」。
    4. 记录 `last_updated` 时间戳（最近一次全量刷新的时间）。

### 4.4 周期性全量刷新（每周一次）

- 设计目标：
    - 避免监控池长期与真实合约列表偏离（例如某些合约下线、状态变更）。
    - 控制全量请求频率，避免资源浪费。
- 行为：
    - 每次程序启动时：
        - 读取本地监控池的 `last_updated`。
        - 若当前时间距离 `last_updated` **超过 7 天**：
            - 触发一次全量刷新（流程同 4.3），更新监控池和 `last_updated`。
        - 若未超过 7 天：
            - 直接使用本地监控池，不做全量刷新。
- 可配置参数：
    - `full_refresh_interval_days`，默认值：`7`。

### 4.5 新合约增量识别（上线后自动加入）

- 需求目标：
    - 在无需人工操作的情况下，以小时级延迟，将 Binance 新上线的 USDT‑M 永续合约自动纳入监控池。
- 行为：
    - 程序长期运行期间，存在一个轻量的后台轮询任务：
        - 轮询频率：默认每 20**分钟**（可配置）。
        - 每次轮询流程：
            1. 再次从 Binance 获取当前 USDT‑M 永续合约列表（同 4.2 的过滤逻辑）。
            2. 与当前监控池进行集合对比：
                - 找出 `new_symbols = 当前列表 − 现有监控池`。
            3. 若 `new_symbols` 非空：
                - 将 `new_symbols` 增量加入监控池。
                - 更新本地持久化存储。
                - 可选：通过 Telegram 推送一条「新合约加入监控池」通知（列出新增 symbol）。
- 可配置参数：
    - `incremental_poll_interval_hours`，默认值：`1`。

### 4.6 监控池持久化存储

- 存储内容：
    - `symbols`: 当前监控池 symbol 列表。
    - `last_updated`: 最近一次全量刷新的时间戳（ISO 格式）。
- 存储介质：
    - MVP 阶段采用本地文件（如 JSON/YAML），便于查看与手工修正。
    - 后续可扩展为数据库存储（如 SQLite/Postgres），无需变更上层逻辑。
- 使用方式：
    - 启动时优先从持久化存储加载监控池（参见 4.4）。
    - 每次全量刷新或增量加入新合约后，立即写回持久化存储。

### 4.7 与监控逻辑的集成

- 监控模块（价格 / CVD / OI / Funding 等）不再使用硬编码 symbol 列表。
- 统一从「监控池管理模块」获取当前 symbol 集合，例如 `current_symbols`。
- 当监控池在运行中增量加入新 symbol 时：
    - 应对新 symbol 进行必要的初始化（CVD 窗口、OI tracker 等）。
    - 新 symbol 在不重启程序的前提下即可被纳入实时报价和告警监控。