name: å¸åœˆç›‘æ§ç³»ç»Ÿ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è§¦å‘ä¸€æ¬¡ä½œä¸ºå®¹é”™

concurrency:
  group: crypto-monitor
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # 5å°æ—¶50åˆ†é’Ÿï¼Œé¿å¼€6å°æ—¶ç¡¬é™åˆ¶
    
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt
        
      - name: è¿è¡Œç›‘æ§ç³»ç»Ÿ
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "ğŸš€ å¯åŠ¨å¸åœˆç›‘æ§ç³»ç»Ÿ..."
          echo "æ—¶é—´: $(date)"
          # è¿è¡Œ 5å°æ—¶50åˆ†é’Ÿ (21000ç§’)ï¼Œç„¶åè‡ªåŠ¨ç»“æŸ
          timeout 21000 python main.py || true
          echo "â° æœ¬è½®ç›‘æ§ç»“æŸï¼Œå‡†å¤‡é‡å¯..."
          
      - name: è§¦å‘ä¸‹ä¸€è½®è¿è¡Œ
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¡ è§¦å‘ä¸‹ä¸€è½® workflow..."
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/monitor.yml/dispatches" \
            -d '{"ref":"main"}' || echo "è§¦å‘å¤±è´¥ï¼Œå°†ç”±å®šæ—¶ä»»åŠ¡æ¢å¤"
